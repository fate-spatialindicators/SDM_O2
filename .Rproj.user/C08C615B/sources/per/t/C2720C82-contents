---
title: "Summary of Sablefish SDM Results"
output: bookdown::pdf_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sdmTMB)
library(dplyr)
library(sp)
library(gsw)
library(ggplot2)
```

## Background

Species distribution modeling attempts to predict local abundance from environmental attributes. One key challenge is that a number of these environmental variables co-vary, and have strong spatial structure.  Contemporary spatial models allow us to ask whether the addition of an environmental covariate leads to better predictions than modeling spatial structure alone.  However, the choice of environmental variables, and the functional form linking environment to species local density needs to be informed by physiological and ecological mechanisms.

The effect of oxygen on species distributions is a prime example.  Basic organismal biology tells us that oxygen acts as a limiting factor on organisms, meaning that we expect to see effects when ability to acquire oxygen exceeds the demand for oxygen.  Recently, the development of the "metabolic index" explicitly measures the ratio of oxygen supply and demand.  The metabolic index is parameterized from species - specific laboratory studies that identify when the supply is less than demand, and how that depends on ambient temperature.  Thus, metabolic index is rooted in specific mechanism of how oxygen affects organisms, and accounts for the effect of temperature on oxygen needs.  Consequently, the metabolic index is now commonly used to evaluate changes in habitat volume under projections of future environmtnal conditions.

One challenge in using the metabolic index is that the data needed to parameterize the index is often lacking.  At present, there is a paucity of studies that have conducted the laboratory experiments that allow for precise measurement of the allometry of the metabolic index, and the effect of temperature.  

One alternative to the specific parametric model derivation of the metabolic index is to use statistical models to survey data, and ask whether the models can reveal species sensitivites to oxygen conditions *in situ*.  Yet, doing so requires careful thought as to how oxygen can be expressed in a statistical model to preserve the underlying mechanism.  For instance, a simple approach of including dissolved oxygen of partial pressure of oxygen as a linear predictor is not consistent with physiological theory or experience.  An alternative approach is statistical breakpoint models, whereby models assume that there is no effect of oxygen above some estimated concentration or pressure, but depends in a linear or log-linear manner below that level.  Further, the dependence of oxygen sensitivity on temperature might be incorporated as a standard interactive effect.

Here we fit distribution models to bottom trawl survey of Sablefish, to ask:
1. Is it possible to distinguish among effects of depth, space, and environmental conditions such as temperature and oxygen, given the strong covariance among these
2. Do models with breakpoint models perform better than those the model oxygen in linear fashion
3. Do statistical models fit to estimated metabolic index perform better than those fit to just dissolved oxygen or partial pressure (i.e. does the dependence of temperature on oxygen needs matter when predicting species distributions, especially given the covariance in temperature, oxygen)


## Alternative Models

We approached this problem by using blah blah blah, fit in R version blah blah, using a very fancy algorithm.

We selected the following models for comparison so that we could address the questions above.  Note that all models include space, year effects, and depth (modeled as a quadradic), and that the spatial effects were constant across years.  This was necessary so that we could then ask whether inter-annual changes in temperature and dissolved oxygen led to differences in local density.  



```{r loadfuns, echo =F}
source("code/mi_functions.R")
```

```{r get_models}
formulas <- get_models()
formulas
```

## Results
#### Model Comparison
```{r model_compare}
use_AIC <- TRUE

m_df <- get_models();
AICmat <- dAIC <- tweedie_dens <- matrix(NA, nrow = length(m_df), ncol =1 ) # set up array for tweedie density
rownames(AICmat) <- rownames(dAIC) <- rownames(tweedie_dens) <- m_df

# Use this if using AIC
if (use_AIC) {
for (i in 1:length(m_df)) {
  filename <- paste0("output/wc/model_",i,"_MI.rds")
  m <- readRDS(filename)
  AICmat[i,1] <-AIC(m)
}

dAIC[,1] <- AICmat[,1] - min(AICmat[,1])
dAIC[,1] <-as.numeric(sprintf(dAIC,fmt = '%.2f'))
dAIC
}
```

```{r plotoxygen1, echo = F,  fig.cap = "Relationship between partial pressure and dissolved oxygen concentrations"}
dat <- load_data()
plot(dat$po2, dat$o2,
type = "p",
pch = 21,
bg = "black",
xlab = "Partial pressure of oxygen",
ylab = "Dissolved oxygen mg / l"
)

```


The best fitting models all contain oxygen-related predicts in a breakpoint model.  The best fitting model used $pO_2$, combined with a linear temperature effect. Dissolved oxygen with temperature also performed well ($\Delta \text{AIC}$ = `r dAIC[11]`), and was nearly indistinguishable from the partial pressure model.  This is not surprising given that the two are highly correlated (Figure \@ref(fig:plotoxygen1)).

```{r plotoxygen2, echo = F, fig.cap = "Oxygen partial pressures by year and space. Only those pressures below the estimated breakpoint are shown (areas with greater oxygen pressures are coded dark blue)"}

# first load models
m_po2 <- readRDS("output/wc/model_13_MI.rds")
m_o2 <- readRDS("output/wc/model_11_MI.rds")
m_null <- readRDS("output/wc/model_2_MI.rds")

dat <- load_data()
# rescale variables
dat$depth = scale(log(dat$depth))
dat$temp = scale(dat$temp)
dat$depth = scale(log(dat$depth))
dat$temp = scale(dat$temp)

mean.po2 <- mean(dat$po2)
std.po2 <- sd(dat$po2)
mean.do <- mean(dat$o2)
std.do <- sd(dat$o2)
mean.mi <- mean(dat$mi)
std.mi <- sd(dat$mi)
dat$mi = scale(dat$mi)
dat$o2 = scale(dat$o2)
dat$po2 <- scale(dat$po2)


predict_po2 <- predict(m_po2)
predict_o2 <- predict(m_o2)
predict_null <- predict(m_null)

fixed_effects_po2 <- m_po2$model$par
bp_ind <- grep("b_threshold", names(fixed_effects_po2))
bp_po2 <- fixed_effects_po2[bp_ind[2]]
slope_po2 <- fixed_effects_po2[bp_ind[1]]

# create new column in data that contains breakpoint if po2 is above breakpoint, and lists the actual po2 otherwise
zeros <- rep(bp_po2, times = nrow(dat))
dat$po2_bp <- zeros

dat$po2_bp[dat$po2<=bp_po2] = back.convert(dat$po2[dat$po2<=bp_po2], mean.po2, std.po2)

# plot the po2 only below the threshold
ggplot(dat, aes(longitude, latitude, col = po2_bp)) + scale_colour_gradient2() +
  geom_point(alpha=0.6, size = 0.5) + facet_wrap(~year) + labs(col = "p02 below breakpoint")
```

```{r plotoxygen3, echo = F, fig.cap ="Spatial distribution of Sablefish"}


ggplot(dat, aes(longitude, latitude, col = log(cpue_kg_km2 ))) + scale_colour_gradient2() +
  geom_point(alpha=0.6, size = 0.5) + facet_wrap(~year)

```


```{r plotoxygen4, echo = F, fig.cap = "Difference in model predictions from breakpoint model with pO2 plus temperature, compared to a model with only temperature (null)"}

# look at difference in predictions between oxygen models and null

predict_po2$delta <- predict_po2$est - predict_null$est
predict_o2$delta <- predict_o2$est - predict_null$est


library(scales)
ggplot(predict_po2, aes(longitude, latitude, col = delta)) + scale_colour_gradient2() +
  geom_point(alpha=0.6, size = 0.5) + facet_wrap(~year) + labs(col = "Delta (po2 - null)")
```


```{r plotoxygen5, echo = F, fig.cap = "Estimated oxygen effect size.  Value of 1.1 means no effect (above the threshold), values of expect size are multipliers times predicted density based on space, year, temperature and depth."}
above <- rep(exp(bp_po2 * slope_po2), times = nrow(dat))
dat$po2_effect <- above

dat$po2_effect[dat$po2<=bp_po2] = exp((dat$po2[dat$po2<=bp_po2])* slope_po2)
ggplot(dat, aes(longitude, latitude, col = po2_effect)) + scale_colour_gradient2() +
  geom_point(alpha=0.6, scale = 0.5) + facet_wrap(~year)

```

## Summary descriptions

Unexpectedly, oxygen levels were greatest in shallow and nearshore areas compared to deeper areas (Figure \@ref(fig:plotoxygen2)).  There were some notable differences accross years, especially in 2011 when there were incursions of low oxygen water in the southern region of the sampling area. There were no profound shifts in sablefish catch rates across the years, at least not based on simple maps (Figure \@ref(fig:plotoxygen3))


We examined how the model predictions were affected by the addition of a breakpoint model on oxygen (here, using pO<sub>2</sub>), compared to its analogous model that otherwise contained the same predictor variables but did not include oxygen.  Despite the fact oxygen is lowest in deeper waters, the largest difference in model predictions occured nearshore (Figure \@ref(fig:plotoxygen4)).  Generally, the null model overpredicted densities nearshore compared to the breakpoint pO<sub>2</sub> model.  We intepret this unexpected finding as evidence that the model was better able to model the effect of depth.  That is, by separating the effects of depth itself, from dissolved oxygen which covaries with depth, the model that included oxygen produced a better curve describing depth effects that were independent from dissolved oxygen.  

The estimated effect of oxygen was relatively strong: namely the model predicts over a 50% reduction in density in areas with the lowest pO<sub>2</sub> (Figure \@ref(fig:plotoxygen5))


